rules_version = '2';

// Helper functions to reduce repetition
function isAuth() {
  return request.auth != null;
}

function isAdmin() {
  return isAuth() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
}

function isQaTester() {
  return isAuth() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'qa_tester';
}

function isRequester() {
  return isAuth() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'requester';
}

function isOwner(userId) {
  return isAuth() && request.auth.uid == userId;
}

service cloud.firestore {
  match /databases/{database}/documents {
    //
    // Users Collection
    //
    match /users/{userId} {
      // Admins can manage all users.
      // Users can read their own data.
      allow read: if isAdmin() || isOwner(userId);
      allow create, update, delete: if isAdmin();
    }
    
    //
    // Roles Collection
    //
    match /roles/{roleId} {
      // Only Admins can manage roles
      allow read, write: if isAdmin();
    }

    //
    // Teams Collection
    //
    match /teams/{teamId} {
      allow read: if isAuth(); // All authenticated users can read teams
      allow write: if isAdmin(); // Only admins can create, update, delete
    }

    //
    // Projects Collection
    //
    match /projects/{projectId} {
      allow read: if isAuth();
      allow write: if isAdmin(); // Only admins can manage projects
    }
    
    //
    // Certificate Requests Collection
    //
    match /requests/{requestId} {
      allow read: if isAdmin() || isQaTester() || (isRequester() && resource.data.requesterId == request.auth.uid);
      allow create: if isRequester();
      // Allow updates from QA for status, or from requesters for feedback
      allow update: if (isQaTester() || isAdmin()) || 
                     (isRequester() && request.resource.data.requesterId == request.auth.uid);
      allow delete: if isAdmin();
    }
    
    //
    // Design Requests Collection
    //
    match /designRequests/{designId} {
        allow read: if isAdmin() || (isAuth() && resource.data.designerId == request.auth.uid);
        allow create: if isAuth(); // Any authenticated user can create for now
        allow update: if isAdmin(); // Only admins can approve/reject
        allow delete: if isAdmin();
    }

    //
    // Certificates Collection
    //
    match /certificates/{certificateId} {
      allow read: if isAuth();
      allow update: if isAdmin() || isQaTester(); // For revoking
    }

    //
    // Comments Collection
    //
    match /comments/{commentId} {
      allow read: if isAuth();
      allow create: if isAuth();
    }

    //
    // HR Collections
    //
    match /infractions/{infractionId} {
        allow read: if isAdmin() || (isAuth() && resource.data.userId == request.auth.uid);
        allow write: if isAdmin();
    }

    match /bonuses/{bonusId} {
        allow read: if isAdmin() || (isAuth() && resource.data.userId == request.auth.uid);
        allow write: if isAdmin();
    }

    match /leaveRequests/{leaveId} {
        allow read: if isAdmin() || (isAuth() && resource.data.userId == request.auth.uid);
        allow create: if isAuth();
        allow update: if isAdmin();
    }
  }
}
